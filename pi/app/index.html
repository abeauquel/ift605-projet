<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Piapp</title>
</head>
<body>
<div style="position: absolute; padding-left: 10px;color: white; padding-top: 50px">

    <h1 id="#heartbeat" style="color: red;">heartbeat : </h1>
    <h1 id="#exercice-name">exercice : </h1>
    <h1 id="#exercice-set">set 1 sur 4 </h1>
    <h1 id="#exercice-repetition">rep 1 sur 12 </h1>
</div>
<div style="right: 0px; position: absolute; padding-right: 10px">
    <h1 id="#connection" style="color: red;">Phone offline</h1>
    <h1 id="#you" style="color: white;">You :</h1>
</div>
<script src="js/three.js"></script>
<script>
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera( 75, window.innerWidth / window.innerHeight, 0.1, 1000 );

    const renderer = new THREE.WebGLRenderer();
    renderer.setSize( window.innerWidth, window.innerHeight );
    document.body.appendChild( renderer.domElement );

    const geometry = new THREE.BoxGeometry();
    const material = new THREE.MeshBasicMaterial( { color: 0x00ff00 } );
    const cube = new THREE.Mesh( geometry, material );
    const cubeExercice = new THREE.Mesh( geometry, material );

    const ACTION_HEART_BEAT = 'heartbeat';
    const ACTION_HEART_ACCEL = 'accel';
    const ACTION_EXERCICE = 'exercice';
    const ACTION_CONNECTION = 'connection';

    const tagHeartBeat = document.getElementById("#heartbeat");
    const tagExerciceName = document.getElementById("#exercice-name");
    const tagExerciceSet = document.getElementById("#exercice-set");
    const tagExerciceRep = document.getElementById("#exercice-repetition");
    const tagConnection = document.getElementById("#connection");
    const tagYou = document.getElementById("#you");

    const socket = new WebSocket('ws://localhost:9898');


    scene.add( cube );
    scene.add( cubeExercice );


    cube.translateX(2);
    cube.translateY(1.5);
    camera.position.z = 5;

    const animate = async function (x, y, z) {
        //requestAnimationFrame( animate );c
        cube.rotation.x += x;
        cube.rotation.y += y;
        //cube.rotation.z += z;
        // cube.translateX(x);
        // cube.translateY(y);
        renderer.render( scene, camera );
    };


    const originXCubeExercice = -3;
    const animateExercice = async function (x, y, z) {
        cubeExercice.position.x = originXCubeExercice + Math.cos(x) ;
        cubeExercice.position.y = Math.sin(y);

    };

    // var xTest = 0;
    // var yTest = 0;
    // var t = 0;
    // var sens = 1;
    // function testRender() {
    //     requestAnimationFrame(testRender);
    //     t+=1;
    //     xTest += 0.05 * sens;
    //     yTest += 0.05 * sens;
    //
    //     if(t > 100){
    //         t=0;
    //         sens = sens *-1;
    //         tagYou.innerText= sens;
    //     }
    //    // sun.rotation.y += 0.005;
    //     //cubeExercice.rotation.y += 0.03;
    //
    //     cubeExercice.position.x = originXCubeExercice + Math.cos(xTest) ;
    //     cubeExercice.position.y = Math.sin(yTest);
    //
    //     renderer.render(scene, camera);
    // }
    // testRender();


    socket.onopen = function(e) {
       console.log("[open] Connection established");
       console.log("Sending to server");
    };

    socket.onmessage = function(event) {
        let data = JSON.parse(event.data);
        console.log(data);
        if(data.action === ACTION_HEART_BEAT){
            tagHeartBeat.innerText = "heartbeat : "+data.value;
        }
        if(data.action === ACTION_HEART_ACCEL){
            animate(data.x, data.y, data.z);
        }
        if(data.action === ACTION_CONNECTION){
            handleConnection(data);
        }

        if(data.action === ACTION_EXERCICE){
            animateExercice(data.x, data.y, data.z);
            tagExerciceName.innerText = "exercice "+ data.name;
            tagExerciceSet.innerText = "set " + data.set;
            tagExerciceRep.innerText = "repetition " + data.repetition;
        }
    };

    let handleConnection = function(data){
        if(data.value){
            tagConnection.innerText="Phone online";
            tagConnection.style.color='green';
        }else {
            tagConnection.innerText="Phone offline";
            tagConnection.style.color='red';
        }
    }

    socket.onclose = function(event) {
        if (event.wasClean) {
            console.log(`[close] Connection closed cleanly, code=${event.code} reason=${event.reason}`);
        } else {
            // e.g. server process killed or network down
            // event.code is usually 1006 in this case
            console.log('[close] Connection died');
        }
    };

    socket.onerror = function(error) {
        console.log(`[error] ${error.message}`);
    };
</script>
</body>
</html>